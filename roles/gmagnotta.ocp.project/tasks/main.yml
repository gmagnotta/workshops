---
- name: Check registry credential exists
  ansible.builtin.assert:
    that:
      - registry_username is defined
      - registry_username != ""
      - registry_password is defined
      - registry_password != ""
    fail_msg: "registry credentials not valid, export the correct values"

- name: Create {{ project }} Namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ project }}"
        labels:
          app: "{{ project }}"

- name: Create Registry {{ registry_name }} Secret
  kubernetes.core.k8s:
    state: present
    template: secret.j2

- name: Read default ServiceAccount
  kubernetes.core.k8s_info:
    kind: ServiceAccount
    name: default
    namespace: "{{ project }}"
  register: default_service_account
  changed_when: false

- name: Link default secret
  ansible.builtin.command: oc secrets link default {{ registry_name }} --for=pull -n {{ project }}
  when:
    - default_service_account.resources[0] is not search(registry_name)

- name: Read builder ServiceAccount
  kubernetes.core.k8s_info:
    kind: ServiceAccount
    name: builder
    namespace: "{{ project }}"
  register: builder_service_account
  changed_when: false
  when: create_builder_secret

- name: Link builder secret
  ansible.builtin.command: oc secrets link builder {{ registry_name }} --for=pull,mount -n {{ project }}
  when: 
    - create_builder_secret
    - builder_service_account.resources[0] is not search(registry_name)

- name: Create OperatorGroup
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: operators.coreos.com/v1
      kind: OperatorGroup
      metadata:
        name: "{{ project }}"
        namespace: "{{ project }}"
      spec:
        targetNamespaces:
          - "{{ project }}"
        upgradeStrategy: Default
  when: create_operator_group